/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { AbstractControl, FormGroup, FormArray, FormControl } from '@angular/forms';
import { getKeyPath, isNullOrUndefined } from '../../utils';
/**
 * \@experimental
 */
var /**
 * \@experimental
 */
FieldFormExtension = /** @class */ (function () {
    function FieldFormExtension() {
    }
    /**
     * @param {?} field
     * @return {?}
     */
    FieldFormExtension.prototype.onPopulate = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        var _this = this;
        var _a;
        if (field.key && field.type) {
            /** @type {?} */
            var paths_1 = getKeyPath({ key: field.key });
            /** @type {?} */
            var rootForm_1 = (/** @type {?} */ (field.parent.formControl));
            /** @type {?} */
            var rootModel_1 = field.fieldGroup ? (_a = {}, _a[paths_1[0]] = field.model, _a) : field.model;
            paths_1.forEach(function (path, index) {
                // FormGroup/FormArray only allow string value for path
                /** @type {?} */
                var formPath = path.toString();
                // is last item
                if (index === paths_1.length - 1) {
                    _this.addFormControl(rootForm_1, field, rootModel_1, formPath);
                }
                else {
                    if (!rootModel_1[path]) {
                        rootModel_1[path] = typeof path === 'string' ? {} : [];
                    }
                    _this.addFormControl(rootForm_1, { key: formPath, fieldGroup: [], modelOptions: {}, templateOptions: {} }, rootModel_1, formPath);
                    rootForm_1 = (/** @type {?} */ (rootForm_1.get(formPath)));
                    rootModel_1 = rootModel_1[path];
                }
            });
        }
        if (field.fieldGroup && !field.formControl) {
            field.formControl = field.parent.formControl;
        }
    };
    /**
     * @private
     * @param {?} form
     * @param {?} field
     * @param {?} model
     * @param {?} path
     * @return {?}
     */
    FieldFormExtension.prototype.addFormControl = /**
     * @private
     * @param {?} form
     * @param {?} field
     * @param {?} model
     * @param {?} path
     * @return {?}
     */
    function (form, field, model, path) {
        /** @type {?} */
        var abstractControlOptions = (/** @type {?} */ ({
            validators: field._validators,
            asyncValidators: field._asyncValidators,
            updateOn: field.modelOptions.updateOn,
        }));
        /** @type {?} */
        var control;
        if (field.formControl instanceof AbstractControl || form.get((/** @type {?} */ (path)))) {
            control = field.formControl || form.get((/** @type {?} */ (path)));
            if (!(isNullOrUndefined(control.value) && isNullOrUndefined(model[path]))
                && control.value !== model[path]
                && control instanceof FormControl) {
                control.patchValue(model[path]);
            }
            if (abstractControlOptions.validators || abstractControlOptions.asyncValidators) {
                if (abstractControlOptions.validators) {
                    control.setValidators(abstractControlOptions.validators);
                }
                if (abstractControlOptions.asyncValidators) {
                    control.setAsyncValidators(abstractControlOptions.asyncValidators);
                }
                control.updateValueAndValidity();
            }
        }
        else if (field._componentFactory && field._componentFactory.component && field._componentFactory.component.createControl) {
            /** @type {?} */
            var component = field._componentFactory.component;
            console.warn("NgxFormly: '" + component.name + "::createControl' is deprecated since v5.0, use 'prePopulate' hook instead.");
            control = component.createControl(model[path], field);
        }
        else if (field.fieldGroup && !field.fieldArray) {
            control = new FormGroup({}, abstractControlOptions);
        }
        else if (field.fieldArray) {
            control = new FormArray([], abstractControlOptions);
        }
        else {
            control = new FormControl(model[path], abstractControlOptions);
        }
        if (field.templateOptions.disabled) {
            control.disable();
        }
        // Replace decorated property with a getter that returns the observable.
        // https://github.com/angular-redux/store/blob/master/src/decorators/select.ts#L79-L85
        if (delete field.templateOptions.disabled) {
            Object.defineProperty(field.templateOptions, 'disabled', {
                get: function () { return !field.formControl.enabled; },
                set: function (value) { return value ? field.formControl.disable() : field.formControl.enable(); },
                enumerable: true,
                configurable: true,
            });
        }
        if (field) {
            field.formControl = control;
        }
        if (form instanceof FormArray) {
            if (form.at((/** @type {?} */ (path))) !== control) {
                form.setControl((/** @type {?} */ (path)), control);
            }
        }
        else {
            if (form.get((/** @type {?} */ (path))) !== control) {
                form.setControl((/** @type {?} */ (path)), control);
            }
        }
    };
    return FieldFormExtension;
}());
/**
 * \@experimental
 */
export { FieldFormExtension };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmllbGQtZm9ybS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZ3gtZm9ybWx5L2NvcmUvIiwic291cmNlcyI6WyJsaWIvZXh0ZW5zaW9ucy9maWVsZC1mb3JtL2ZpZWxkLWZvcm0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUVBLE9BQU8sRUFBRSxlQUFlLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQTBCLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUcsT0FBTyxFQUFFLFVBQVUsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGFBQWEsQ0FBQzs7OztBQUc1RDs7OztJQUFBO0lBZ0dBLENBQUM7Ozs7O0lBL0ZDLHVDQUFVOzs7O0lBQVYsVUFBVyxLQUE2QjtRQUF4QyxpQkF5QkM7O1FBeEJDLElBQUksS0FBSyxDQUFDLEdBQUcsSUFBSSxLQUFLLENBQUMsSUFBSSxFQUFFOztnQkFDckIsT0FBSyxHQUFHLFVBQVUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUM7O2dCQUN4QyxVQUFRLEdBQUcsbUJBQUEsS0FBSyxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQWE7O2dCQUFFLFdBQVMsR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsV0FBRyxHQUFDLE9BQUssQ0FBQyxDQUFDLENBQUMsSUFBRyxLQUFLLENBQUMsS0FBSyxNQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSztZQUM5SCxPQUFLLENBQUMsT0FBTyxDQUFDLFVBQUMsSUFBSSxFQUFFLEtBQUs7OztvQkFFbEIsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUU7Z0JBQ2hDLGVBQWU7Z0JBQ2YsSUFBSSxLQUFLLEtBQUssT0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7b0JBQzlCLEtBQUksQ0FBQyxjQUFjLENBQUMsVUFBUSxFQUFFLEtBQUssRUFBRSxXQUFTLEVBQUUsUUFBUSxDQUFDLENBQUM7aUJBQzNEO3FCQUFNO29CQUNMLElBQUksQ0FB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RUFBRTtnQkFDdEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxtQkFBUyxJQUFJLEVBQUEsRUFBRSxPQUFPLENBQUMsQ0FBQzthQUN6QztTQUNGO2FBQU07WUFDTCxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsbUJBQVMsSUFBSSxFQUFBLENBQUMsS0FBSyxPQUFPLEVBQUU7Z0JBQ3ZDLElBQUksQ0FBQyxVQUFVLENBQUMsbUJBQVMsSUFBSSxFQUFBLEVBQUUsT0FBTyxDQUFDLENBQUM7YUFDekM7U0FDRjtJQUNILENBQUM7SUFDSCx5QkFBQztBQUFELENBQUMsQUFoR0QsSUFnR0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGb3JtbHlFeHRlbnNpb24gfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9mb3JtbHkuY29uZmlnJztcbmltcG9ydCB7IEZvcm1seUZpZWxkQ29uZmlnQ2FjaGUgfSBmcm9tICcuLi8uLi9jb21wb25lbnRzL2Zvcm1seS5maWVsZC5jb25maWcnO1xuaW1wb3J0IHsgQWJzdHJhY3RDb250cm9sLCBGb3JtR3JvdXAsIEZvcm1BcnJheSwgRm9ybUNvbnRyb2wsIEFic3RyYWN0Q29udHJvbE9wdGlvbnMgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBnZXRLZXlQYXRoLCBpc051bGxPclVuZGVmaW5lZCB9IGZyb20gJy4uLy4uL3V0aWxzJztcblxuLyoqIEBleHBlcmltZW50YWwgKi9cbmV4cG9ydCBjbGFzcyBGaWVsZEZvcm1FeHRlbnNpb24gaW1wbGVtZW50cyBGb3JtbHlFeHRlbnNpb24ge1xuICBvblBvcHVsYXRlKGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZ0NhY2hlKSB7XG4gICAgaWYgKGZpZWxkLmtleSAmJiBmaWVsZC50eXBlKSB7XG4gICAgICBjb25zdCBwYXRocyA9IGdldEtleVBhdGgoeyBrZXk6IGZpZWxkLmtleSB9KTtcbiAgICAgIGxldCByb290Rm9ybSA9IGZpZWxkLnBhcmVudC5mb3JtQ29udHJvbCBhcyBGb3JtR3JvdXAsIHJvb3RNb2RlbCA9IGZpZWxkLmZpZWxkR3JvdXAgPyB7IFtwYXRoc1swXV06IGZpZWxkLm1vZGVsIH0gOiBmaWVsZC5tb2RlbDtcbiAgICAgIHBhdGhzLmZvckVhY2goKHBhdGgsIGluZGV4KSA9PiB7XG4gICAgICAgIC8vIEZvcm1Hcm91cC9Gb3JtQXJyYXkgb25seSBhbGxvdyBzdHJpbmcgdmFsdWUgZm9yIHBhdGhcbiAgICAgICAgY29uc3QgZm9ybVBhdGggPSBwYXRoLnRvU3RyaW5nKCk7XG4gICAgICAgIC8vIGlzIGxhc3QgaXRlbVxuICAgICAgICBpZiAoaW5kZXggPT09IHBhdGhzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICB0aGlzLmFkZEZvcm1Db250cm9sKHJvb3RGb3JtLCBmaWVsZCwgcm9vdE1vZGVsLCBmb3JtUGF0aCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKCFyb290TW9kZWxbcGF0aF0pIHtcbiAgICAgICAgICAgIHJvb3RNb2RlbFtwYXRoXSA9IHR5cGVvZiBwYXRoID09PSAnc3RyaW5nJyA/IHt9IDogW107XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuYWRkRm9ybUNvbnRyb2wocm9vdEZvcm0sIHsga2V5OiBmb3JtUGF0aCwgZmllbGRHcm91cDogW10sIG1vZGVsT3B0aW9uczoge30sIHRlbXBsYXRlT3B0aW9uczoge30gfSwgcm9vdE1vZGVsLCBmb3JtUGF0aCk7XG5cbiAgICAgICAgICByb290Rm9ybSA9IDxGb3JtR3JvdXA+IHJvb3RGb3JtLmdldChmb3JtUGF0aCk7XG4gICAgICAgICAgcm9vdE1vZGVsID0gcm9vdE1vZGVsW3BhdGhdO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoZmllbGQuZmllbGRHcm91cCAmJiAhZmllbGQuZm9ybUNvbnRyb2wpIHtcbiAgICAgIGZpZWxkLmZvcm1Db250cm9sID0gZmllbGQucGFyZW50LmZvcm1Db250cm9sO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkRm9ybUNvbnRyb2woZm9ybTogRm9ybUdyb3VwIHwgRm9ybUFycmF5LCBmaWVsZDogRm9ybWx5RmllbGRDb25maWdDYWNoZSwgbW9kZWw6IGFueSwgcGF0aDogc3RyaW5nIHwgbnVtYmVyKSB7XG4gICAgY29uc3QgYWJzdHJhY3RDb250cm9sT3B0aW9ucyA9IHtcbiAgICAgIHZhbGlkYXRvcnM6IGZpZWxkLl92YWxpZGF0b3JzLFxuICAgICAgYXN5bmNWYWxpZGF0b3JzOiBmaWVsZC5fYXN5bmNWYWxpZGF0b3JzLFxuICAgICAgdXBkYXRlT246IGZpZWxkLm1vZGVsT3B0aW9ucy51cGRhdGVPbixcbiAgICB9IGFzIEFic3RyYWN0Q29udHJvbE9wdGlvbnM7XG4gICAgbGV0IGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbDtcblxuICAgIGlmIChmaWVsZC5mb3JtQ29udHJvbCBpbnN0YW5jZW9mIEFic3RyYWN0Q29udHJvbCB8fCBmb3JtLmdldCg8c3RyaW5nPiBwYXRoKSkge1xuICAgICAgY29udHJvbCA9IGZpZWxkLmZvcm1Db250cm9sIHx8IGZvcm0uZ2V0KDxzdHJpbmc+IHBhdGgpO1xuICAgICAgaWYgKFxuICAgICAgICAhKGlzTnVsbE9yVW5kZWZpbmVkKGNvbnRyb2wudmFsdWUpICYmIGlzTnVsbE9yVW5kZWZpbmVkKG1vZGVsW3BhdGhdKSlcbiAgICAgICAgJiYgY29udHJvbC52YWx1ZSAhPT0gbW9kZWxbcGF0aF1cbiAgICAgICAgJiYgY29udHJvbCBpbnN0YW5jZW9mIEZvcm1Db250cm9sXG4gICAgICApIHtcbiAgICAgICAgY29udHJvbC5wYXRjaFZhbHVlKG1vZGVsW3BhdGhdKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGFic3RyYWN0Q29udHJvbE9wdGlvbnMudmFsaWRhdG9ycyB8fCBhYnN0cmFjdENvbnRyb2xPcHRpb25zLmFzeW5jVmFsaWRhdG9ycykge1xuICAgICAgICBpZiAoYWJzdHJhY3RDb250cm9sT3B0aW9ucy52YWxpZGF0b3JzKSB7XG4gICAgICAgICAgY29udHJvbC5zZXRWYWxpZGF0b3JzKGFic3RyYWN0Q29udHJvbE9wdGlvbnMudmFsaWRhdG9ycyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGFic3RyYWN0Q29udHJvbE9wdGlvbnMuYXN5bmNWYWxpZGF0b3JzKSB7XG4gICAgICAgICAgY29udHJvbC5zZXRBc3luY1ZhbGlkYXRvcnMoYWJzdHJhY3RDb250cm9sT3B0aW9ucy5hc3luY1ZhbGlkYXRvcnMpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnRyb2wudXBkYXRlVmFsdWVBbmRWYWxpZGl0eSgpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZmllbGQuX2NvbXBvbmVudEZhY3RvcnkgJiYgZmllbGQuX2NvbXBvbmVudEZhY3RvcnkuY29tcG9uZW50ICYmIGZpZWxkLl9jb21wb25lbnRGYWN0b3J5LmNvbXBvbmVudC5jcmVhdGVDb250cm9sKSB7XG4gICAgICBjb25zdCBjb21wb25lbnQgPSBmaWVsZC5fY29tcG9uZW50RmFjdG9yeS5jb21wb25lbnQ7XG4gICAgICBjb25zb2xlLndhcm4oYE5neEZvcm1seTogJyR7Y29tcG9uZW50Lm5hbWV9OjpjcmVhdGVDb250cm9sJyBpcyBkZXByZWNhdGVkIHNpbmNlIHY1LjAsIHVzZSAncHJlUG9wdWxhdGUnIGhvb2sgaW5zdGVhZC5gKTtcbiAgICAgIGNvbnRyb2wgPSBjb21wb25lbnQuY3JlYXRlQ29udHJvbChtb2RlbFtwYXRoXSwgZmllbGQpO1xuICAgIH0gZWxzZSBpZiAoZmllbGQuZmllbGRHcm91cCAmJiAhZmllbGQuZmllbGRBcnJheSkge1xuICAgICAgY29udHJvbCA9IG5ldyBGb3JtR3JvdXAoe30sIGFic3RyYWN0Q29udHJvbE9wdGlvbnMpO1xuICAgIH0gZWxzZSBpZiAoZmllbGQuZmllbGRBcnJheSkge1xuICAgICAgY29udHJvbCA9IG5ldyBGb3JtQXJyYXkoW10sIGFic3RyYWN0Q29udHJvbE9wdGlvbnMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb250cm9sID0gbmV3IEZvcm1Db250cm9sKG1vZGVsW3BhdGhdLCBhYnN0cmFjdENvbnRyb2xPcHRpb25zKTtcbiAgICB9XG5cbiAgICBpZiAoZmllbGQudGVtcGxhdGVPcHRpb25zLmRpc2FibGVkKSB7XG4gICAgICBjb250cm9sLmRpc2FibGUoKTtcbiAgICB9XG5cbiAgICAvLyBSZXBsYWNlIGRlY29yYXRlZCBwcm9wZXJ0eSB3aXRoIGEgZ2V0dGVyIHRoYXQgcmV0dXJucyB0aGUgb2JzZXJ2YWJsZS5cbiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci1yZWR1eC9zdG9yZS9ibG9iL21hc3Rlci9zcmMvZGVjb3JhdG9ycy9zZWxlY3QudHMjTDc5LUw4NVxuICAgIGlmIChkZWxldGUgZmllbGQudGVtcGxhdGVPcHRpb25zLmRpc2FibGVkKSB7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZmllbGQudGVtcGxhdGVPcHRpb25zLCAnZGlzYWJsZWQnLCB7XG4gICAgICAgIGdldDogKCkgPT4gIWZpZWxkLmZvcm1Db250cm9sLmVuYWJsZWQsXG4gICAgICAgIHNldDogKHZhbHVlOiBib29sZWFuKSA9PiB2YWx1ZSA/IGZpZWxkLmZvcm1Db250cm9sLmRpc2FibGUoKSA6IGZpZWxkLmZvcm1Db250cm9sLmVuYWJsZSgpLFxuICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICBjb25maWd1cmFibGU6IHRydWUsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoZmllbGQpIHtcbiAgICAgIGZpZWxkLmZvcm1Db250cm9sID0gY29udHJvbDtcbiAgICB9XG5cbiAgICBpZiAoZm9ybSBpbnN0YW5jZW9mIEZvcm1BcnJheSkge1xuICAgICAgaWYgKGZvcm0uYXQoPG51bWJlcj4gcGF0aCkgIT09IGNvbnRyb2wpIHtcbiAgICAgICAgZm9ybS5zZXRDb250cm9sKDxudW1iZXI+IHBhdGgsIGNvbnRyb2wpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoZm9ybS5nZXQoPHN0cmluZz4gcGF0aCkgIT09IGNvbnRyb2wpIHtcbiAgICAgICAgZm9ybS5zZXRDb250cm9sKDxzdHJpbmc+IHBhdGgsIGNvbnRyb2wpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19