/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Validators } from '@angular/forms';
import { isObject, FORMLY_VALIDATORS, defineHiddenProp } from '../../utils';
/**
 * \@experimental
 */
var /**
 * \@experimental
 */
FieldValidationExtension = /** @class */ (function () {
    function FieldValidationExtension(formlyConfig) {
        this.formlyConfig = formlyConfig;
    }
    /**
     * @param {?} field
     * @return {?}
     */
    FieldValidationExtension.prototype.onPopulate = /**
     * @param {?} field
     * @return {?}
     */
    function (field) {
        this.initFieldValidation(field);
        this.initFieldAsyncValidation(field);
    };
    /**
     * @private
     * @param {?} field
     * @return {?}
     */
    FieldValidationExtension.prototype.initFieldValidation = /**
     * @private
     * @param {?} field
     * @return {?}
     */
    function (field) {
        var _this = this;
        if (field._validators) {
            return;
        }
        defineHiddenProp(field, '_validators', []);
        this.initPredefinedFieldValidation(field);
        if (field.validators) {
            var _loop_1 = function (validatorName) {
                if (validatorName !== 'validation') {
                    /** @type {?} */
                    var validator_1 = field.validators[validatorName];
                    /** @type {?} */
                    var errorPath_1;
                    /** @type {?} */
                    var message_1;
                    if (isObject(validator_1)) {
                        errorPath_1 = validator_1.errorPath;
                        message_1 = validator_1.message;
                        validator_1 = validator_1.expression;
                    }
                    field._validators.push(function (control) {
                        var _a, _b;
                        /** @type {?} */
                        var isValid = validator_1(control, field);
                        if (errorPath_1 && field.formControl && field.formControl.get(errorPath_1)) {
                            if (!isValid) {
                                field.formControl.get(errorPath_1).setErrors(tslib_1.__assign({}, (field.formControl.get(errorPath_1).errors || {}), (_a = {}, _a[validatorName] = { message: message_1 }, _a)));
                            }
                            else {
                                /** @type {?} */
                                var errors = (field.formControl.get(errorPath_1).errors || {});
                                delete errors[validatorName];
                                field.formControl.get(errorPath_1).setErrors(Object.keys(errors).length === 0 ? null : errors);
                            }
                        }
                        return isValid ? null : (_b = {}, _b[validatorName] = errorPath_1 ? { errorPath: errorPath_1 } : true, _b);
                    });
                }
                else {
                    if (!Array.isArray(field.validators.validation)) {
                        field.validators.validation = [field.validators.validation];
                    }
                    field.validators.validation
                        .forEach(function (validator) { return field._validators.push(_this.wrapNgValidatorFn(field, validator)); });
                }
            };
            for (var validatorName in field.validators) {
                _loop_1(validatorName);
            }
        }
    };
    /**
     * @private
     * @param {?} field
     * @return {?}
     */
    FieldValidationExtension.prototype.initFieldAsyncValidation = /**
     * @private
     * @param {?} field
     * @return {?}
     */
    function (field) {
        var _this = this;
        if (field._asyncValidators) {
            return;
        }
        defineHiddenProp(field, '_asyncValidators', []);
        if (field.asyncValidators) {
            var _loop_2 = function (validatorName) {
                if (validatorName !== 'validation') {
                    /** @type {?} */
                    var validator_2 = field.asyncValidators[validatorName];
                    if (isObject(validator_2)) {
                        validator_2 = validator_2.expression;
                    }
                    field._asyncValidators.push(function (control) { return new Promise(function (resolve) {
                        return validator_2(control, field).then(function (result) {
                            var _a;
                            resolve(result ? null : (_a = {}, _a[validatorName] = true, _a));
                        });
                    }); });
                }
                else {
                    if (!Array.isArray(field.asyncValidators.validation)) {
                        field.asyncValidators.validation = [field.asyncValidators.validation];
                    }
                    field.asyncValidators.validation
                        .forEach(function (validator) { return field._asyncValidators.push((/** @type {?} */ (_this.wrapNgValidatorFn(field, validator)))); });
                }
            };
            for (var validatorName in field.asyncValidators) {
                _loop_2(validatorName);
            }
        }
    };
    /**
     * @private
     * @param {?} field
     * @return {?}
     */
    FieldValidationExtension.prototype.initPredefinedFieldValidation = /**
     * @private
     * @param {?} field
     * @return {?}
     */
    function (field) {
        FORMLY_VALIDATORS
            .filter(function (opt) { return (field.templateOptions && field.templateOptions.hasOwnProperty(opt)) || (field.expressionProperties && field.expressionProperties["templateOptions." + opt]); })
            .forEach(function (opt) {
            field._validators.push(function (control) {
                /** @type {?} */
                var value = field.templateOptions[opt];
                if (value === false) {
                    return null;
                }
                switch (opt) {
                    case 'required':
                        return Validators.required(control);
                    case 'pattern':
                        return Validators.pattern(value)(control);
                    case 'minLength':
                        return Validators.minLength(value)(control);
                    case 'maxLength':
                        return Validators.maxLength(value)(control);
                    case 'min':
                        return Validators.min(value)(control);
                    case 'max':
                        return Validators.max(value)(control);
                }
            });
        });
    };
    /**
     * @private
     * @param {?} field
     * @param {?} validator
     * @return {?}
     */
    FieldValidationExtension.prototype.wrapNgValidatorFn = /**
     * @private
     * @param {?} field
     * @param {?} validator
     * @return {?}
     */
    function (field, validator) {
        validator = typeof validator === 'string'
            ? this.formlyConfig.getValidator(validator).validation
            : validator;
        return function (control) { return ((/** @type {?} */ (validator)))(control, field); };
    };
    return FieldValidationExtension;
}());
/**
 * \@experimental
 */
export { FieldValidationExtension };
if (false) {
    /**
     * @type {?}
     * @private
     */
    FieldValidationExtension.prototype.formlyConfig;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmllbGQtdmFsaWRhdGlvbi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZ3gtZm9ybWx5L2NvcmUvIiwic291cmNlcyI6WyJsaWIvZXh0ZW5zaW9ucy9maWVsZC12YWxpZGF0aW9uL2ZpZWxkLXZhbGlkYXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFFQSxPQUFPLEVBQW1CLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdELE9BQU8sRUFBRSxRQUFRLEVBQUUsaUJBQWlCLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxhQUFhLENBQUM7Ozs7QUFHNUU7Ozs7SUFDRSxrQ0FBb0IsWUFBMEI7UUFBMUIsaUJBQVksR0FBWixZQUFZLENBQWM7SUFBRyxDQUFDOzs7OztJQUVsRCw2Q0FBVTs7OztJQUFWLFVBQVcsS0FBNkI7UUFDdEMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2hDLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN2QyxDQUFDOzs7Ozs7SUFFTyxzREFBbUI7Ozs7O0lBQTNCLFVBQTRCLEtBQTZCO1FBQXpELGlCQTZDQztRQTVDQyxJQUFJLEtBQUssQ0FBQyxXQUFXLEVBQUU7WUFDckIsT0FBTztTQUNSO1FBRUQsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLGFBQWEsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUMzQyxJQUFJLENBQUMsNkJBQTZCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDMUMsSUFBSSxLQUFLLENBQUMsVUFBVSxFQUFFO29DQUNULGFBQWE7Z0JBQ3RCLElBQUksYUFBYSxLQUFLLFlBQVksRUFBRTs7d0JBQzlCLFdBQVMsR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQzs7d0JBQzNDLFdBQVM7O3dCQUNULFNBQU87b0JBQ1gsSUFBSSxRQUFRLENBQUMsV0FBUyxDQUFDLEVBQUU7d0JBQ3ZCLFdBQVMsR0FBRyxXQUFTLENBQUMsU0FBUyxDQUFDO3dCQUNo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QztRQUVkLE9BQU8sVUFBQyxPQUF3QixJQUFLLE9BQUEsQ0FBQyxtQkFBQSxTQUFTLEVBQW9CLENBQUMsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLEVBQS9DLENBQStDLENBQUM7SUFDdkYsQ0FBQztJQUNILCtCQUFDO0FBQUQsQ0FBQyxBQXZIRCxJQXVIQzs7Ozs7Ozs7OztJQXRIYSxnREFBa0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGb3JtbHlFeHRlbnNpb24sIEZpZWxkVmFsaWRhdG9yRm4sIEZvcm1seUNvbmZpZyB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2Zvcm1seS5jb25maWcnO1xuaW1wb3J0IHsgRm9ybWx5RmllbGRDb25maWdDYWNoZSB9IGZyb20gJy4uLy4uL2NvbXBvbmVudHMvZm9ybWx5LmZpZWxkLmNvbmZpZyc7XG5pbXBvcnQgeyBBYnN0cmFjdENvbnRyb2wsIFZhbGlkYXRvcnMgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBpc09iamVjdCwgRk9STUxZX1ZBTElEQVRPUlMsIGRlZmluZUhpZGRlblByb3AgfSBmcm9tICcuLi8uLi91dGlscyc7XG5cbi8qKiBAZXhwZXJpbWVudGFsICovXG5leHBvcnQgY2xhc3MgRmllbGRWYWxpZGF0aW9uRXh0ZW5zaW9uIGltcGxlbWVudHMgRm9ybWx5RXh0ZW5zaW9uIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBmb3JtbHlDb25maWc6IEZvcm1seUNvbmZpZykge31cblxuICBvblBvcHVsYXRlKGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZ0NhY2hlKSB7XG4gICAgdGhpcy5pbml0RmllbGRWYWxpZGF0aW9uKGZpZWxkKTtcbiAgICB0aGlzLmluaXRGaWVsZEFzeW5jVmFsaWRhdGlvbihmaWVsZCk7XG4gIH1cblxuICBwcml2YXRlIGluaXRGaWVsZFZhbGlkYXRpb24oZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnQ2FjaGUpIHtcbiAgICBpZiAoZmllbGQuX3ZhbGlkYXRvcnMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBkZWZpbmVIaWRkZW5Qcm9wKGZpZWxkLCAnX3ZhbGlkYXRvcnMnLCBbXSk7XG4gICAgdGhpcy5pbml0UHJlZGVmaW5lZEZpZWxkVmFsaWRhdGlvbihmaWVsZCk7XG4gICAgaWYgKGZpZWxkLnZhbGlkYXRvcnMpIHtcbiAgICAgIGZvciAoY29uc3QgdmFsaWRhdG9yTmFtZSBpbiBmaWVsZC52YWxpZGF0b3JzKSB7XG4gICAgICAgIGlmICh2YWxpZGF0b3JOYW1lICE9PSAndmFsaWRhdGlvbicpIHtcbiAgICAgICAgICBsZXQgdmFsaWRhdG9yID0gZmllbGQudmFsaWRhdG9yc1t2YWxpZGF0b3JOYW1lXTtcbiAgICAgICAgICBsZXQgZXJyb3JQYXRoO1xuICAgICAgICAgIGxldCBtZXNzYWdlO1xuICAgICAgICAgIGlmIChpc09iamVjdCh2YWxpZGF0b3IpKSB7XG4gICAgICAgICAgICBlcnJvclBhdGggPSB2YWxpZGF0b3IuZXJyb3JQYXRoO1xuICAgICAgICAgICAgbWVzc2FnZSA9IHZhbGlkYXRvci5tZXNzYWdlO1xuICAgICAgICAgICAgdmFsaWRhdG9yID0gdmFsaWRhdG9yLmV4cHJlc3Npb247XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZmllbGQuX3ZhbGlkYXRvcnMucHVzaCgoY29udHJvbDogQWJzdHJhY3RDb250cm9sKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpc1ZhbGlkID0gdmFsaWRhdG9yKGNvbnRyb2wsIGZpZWxkKTtcbiAgICAgICAgICAgIGlmIChlcnJvclBhdGggJiYgZmllbGQuZm9ybUNvbnRyb2wgJiYgZmllbGQuZm9ybUNvbnRyb2wuZ2V0KGVycm9yUGF0aCkpIHtcbiAgICAgICAgICAgICAgaWYgKCFpc1ZhbGlkKSB7XG4gICAgICAgICAgICAgICAgZmllbGQuZm9ybUNvbnRyb2wuZ2V0KGVycm9yUGF0aCkuc2V0RXJyb3JzKHtcbiAgICAgICAgICAgICAgICAgIC4uLihmaWVsZC5mb3JtQ29udHJvbC5nZXQoZXJyb3JQYXRoKS5lcnJvcnMgfHwge30pLFxuICAgICAgICAgICAgICAgICAgW3ZhbGlkYXRvck5hbWVdOiB7IG1lc3NhZ2UgfSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBlcnJvcnMgPSAoZmllbGQuZm9ybUNvbnRyb2wuZ2V0KGVycm9yUGF0aCkuZXJyb3JzIHx8IHt9KTtcbiAgICAgICAgICAgICAgICBkZWxldGUgZXJyb3JzW3ZhbGlkYXRvck5hbWVdO1xuICAgICAgICAgICAgICAgIGZpZWxkLmZvcm1Db250cm9sLmdldChlcnJvclBhdGgpLnNldEVycm9ycyhPYmplY3Qua2V5cyhlcnJvcnMpLmxlbmd0aCA9PT0gMCA/IG51bGwgOiBlcnJvcnMpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBpc1ZhbGlkID8gbnVsbCA6IHsgW3ZhbGlkYXRvck5hbWVdOiBlcnJvclBhdGggPyB7IGVycm9yUGF0aCB9IDogdHJ1ZSB9O1xuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShmaWVsZC52YWxpZGF0b3JzLnZhbGlkYXRpb24pKSB7XG4gICAgICAgICAgICBmaWVsZC52YWxpZGF0b3JzLnZhbGlkYXRpb24gPSBbZmllbGQudmFsaWRhdG9ycy52YWxpZGF0aW9uXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZmllbGQudmFsaWRhdG9ycy52YWxpZGF0aW9uXG4gICAgICAgICAgICAuZm9yRWFjaCgodmFsaWRhdG9yOiBhbnkpID0+IGZpZWxkLl92YWxpZGF0b3JzLnB1c2godGhpcy53cmFwTmdWYWxpZGF0b3JGbihmaWVsZCwgdmFsaWRhdG9yKSkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpbml0RmllbGRBc3luY1ZhbGlkYXRpb24oZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnQ2FjaGUpIHtcbiAgICBpZiAoZmllbGQuX2FzeW5jVmFsaWRhdG9ycykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGRlZmluZUhpZGRlblByb3AoZmllbGQsICdfYXN5bmNWYWxpZGF0b3JzJywgW10pO1xuICAgIGlmIChmaWVsZC5hc3luY1ZhbGlkYXRvcnMpIHtcbiAgICAgIGZvciAoY29uc3QgdmFsaWRhdG9yTmFtZSBpbiBmaWVsZC5hc3luY1ZhbGlkYXRvcnMpIHtcbiAgICAgICAgaWYgKHZhbGlkYXRvck5hbWUgIT09ICd2YWxpZGF0aW9uJykge1xuICAgICAgICAgIGxldCB2YWxpZGF0b3IgPSBmaWVsZC5hc3luY1ZhbGlkYXRvcnNbdmFsaWRhdG9yTmFtZV07XG4gICAgICAgICAgaWYgKGlzT2JqZWN0KHZhbGlkYXRvcikpIHtcbiAgICAgICAgICAgIHZhbGlkYXRvciA9IHZhbGlkYXRvci5leHByZXNzaW9uO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGZpZWxkLl9hc3luY1ZhbGlkYXRvcnMucHVzaCgoY29udHJvbDogQWJzdHJhY3RDb250cm9sKSA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHZhbGlkYXRvcihjb250cm9sLCBmaWVsZCkudGhlbigocmVzdWx0OiBib29sZWFuKSA9PiB7XG4gICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0ID8gbnVsbCA6IHsgW3ZhbGlkYXRvck5hbWVdOiB0cnVlIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShmaWVsZC5hc3luY1ZhbGlkYXRvcnMudmFsaWRhdGlvbikpIHtcbiAgICAgICAgICAgIGZpZWxkLmFzeW5jVmFsaWRhdG9ycy52YWxpZGF0aW9uID0gW2ZpZWxkLmFzeW5jVmFsaWRhdG9ycy52YWxpZGF0aW9uXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZmllbGQuYXN5bmNWYWxpZGF0b3JzLnZhbGlkYXRpb25cbiAgICAgICAgICAgIC5mb3JFYWNoKCh2YWxpZGF0b3I6IGFueSkgPT4gZmllbGQuX2FzeW5jVmFsaWRhdG9ycy5wdXNoKHRoaXMud3JhcE5nVmFsaWRhdG9yRm4oZmllbGQsIHZhbGlkYXRvcikgYXMgYW55KSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGluaXRQcmVkZWZpbmVkRmllbGRWYWxpZGF0aW9uKGZpZWxkOiBGb3JtbHlGaWVsZENvbmZpZ0NhY2hlKSB7XG4gICAgRk9STUxZX1ZBTElEQVRPUlNcbiAgICAgIC5maWx0ZXIob3B0ID0+IChmaWVsZC50ZW1wbGF0ZU9wdGlvbnMgJiYgZmllbGQudGVtcGxhdGVPcHRpb25zLmhhc093blByb3BlcnR5KG9wdCkpIHx8IChmaWVsZC5leHByZXNzaW9uUHJvcGVydGllcyAmJiBmaWVsZC5leHByZXNzaW9uUHJvcGVydGllc1tgdGVtcGxhdGVPcHRpb25zLiR7b3B0fWBdKSlcbiAgICAgIC5mb3JFYWNoKChvcHQpID0+IHtcbiAgICAgICAgZmllbGQuX3ZhbGlkYXRvcnMucHVzaCgoY29udHJvbDogQWJzdHJhY3RDb250cm9sKSA9PiB7XG4gICAgICAgICAgY29uc3QgdmFsdWUgPSBmaWVsZC50ZW1wbGF0ZU9wdGlvbnNbb3B0XTtcbiAgICAgICAgICBpZiAodmFsdWUgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICB9XG4gICAgICAgICAgc3dpdGNoIChvcHQpIHtcbiAgICAgICAgICAgIGNhc2UgJ3JlcXVpcmVkJzpcbiAgICAgICAgICAgICAgcmV0dXJuIFZhbGlkYXRvcnMucmVxdWlyZWQoY29udHJvbCk7XG4gICAgICAgICAgICBjYXNlICdwYXR0ZXJuJzpcbiAgICAgICAgICAgICAgcmV0dXJuIFZhbGlkYXRvcnMucGF0dGVybih2YWx1ZSkoY29udHJvbCk7XG4gICAgICAgICAgICBjYXNlICdtaW5MZW5ndGgnOlxuICAgICAgICAgICAgICByZXR1cm4gVmFsaWRhdG9ycy5taW5MZW5ndGgodmFsdWUpKGNvbnRyb2wpO1xuICAgICAgICAgICAgY2FzZSAnbWF4TGVuZ3RoJzpcbiAgICAgICAgICAgICAgcmV0dXJuIFZhbGlkYXRvcnMubWF4TGVuZ3RoKHZhbHVlKShjb250cm9sKTtcbiAgICAgICAgICAgIGNhc2UgJ21pbic6XG4gICAgICAgICAgICAgIHJldHVybiBWYWxpZGF0b3JzLm1pbih2YWx1ZSkoY29udHJvbCk7XG4gICAgICAgICAgICBjYXNlICdtYXgnOlxuICAgICAgICAgICAgICByZXR1cm4gVmFsaWRhdG9ycy5tYXgodmFsdWUpKGNvbnRyb2wpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgd3JhcE5nVmFsaWRhdG9yRm4oZmllbGQ6IEZvcm1seUZpZWxkQ29uZmlnQ2FjaGUsIHZhbGlkYXRvcjogc3RyaW5nIHwgRmllbGRWYWxpZGF0b3JGbikge1xuICAgIHZhbGlkYXRvciA9IHR5cGVvZiB2YWxpZGF0b3IgPT09ICdzdHJpbmcnXG4gICAgICA/IHRoaXMuZm9ybWx5Q29uZmlnLmdldFZhbGlkYXRvcih2YWxpZGF0b3IpLnZhbGlkYXRpb25cbiAgICAgIDogdmFsaWRhdG9yO1xuXG4gICAgcmV0dXJuIChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpID0+ICh2YWxpZGF0b3IgYXMgRmllbGRWYWxpZGF0b3JGbikoY29udHJvbCwgZmllbGQpO1xuICB9XG59XG4iXX0=